<!DOCTYPE html>
<html>

<head>
  <title>DSCI 554 Lab ex6</title>

  <link href="./node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="./node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="./style.css">
  
  <link href="node_modules/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  
  <link rel="stylesheet" href="./github-dark-dimmed.min.css">
  <script src="./highlight.min.js"></script>
  
  <script src="./node_modules/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
  <link rel="stylesheet" href="./node_modules/highlightjs-copy/dist/highlightjs-copy.min.css"/>

  <script src="./node_modules/d3/dist/d3.min.js"></script>
  
  <script>
  hljs.highlightAll();
  hljs.addPlugin(new CopyButtonPlugin());
  </script>
</head>

<body>
  <h1>Gender Wage Gap and Life Expectancy at Birth for Belarus, Indonesia, Mexico, Paraguay, the Philippines, Singapore, Sri Lanka, Sweden, and the United Kingdom in 2008
  </h1>
  <style>
    .axis path,
    .axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }
  
    .axis text {
      font-family: Courier;
      font-size: 0.85em;
    }
  
    text {
      font-family: Courier;
      font-size: 0.65em;
    }
  
    svg {
      display: block;
      margin: auto;
      background-color: #fafafa;
    }
  
    .bar {
      fill: #add8e677;  /* #add8e6 is hex code for lightblue */
    }
  
    text.label {
      text-anchor: middle;
      alignment-baseline: central;
    }
  
    text.name {
      font-weight: bold;
      text-anchor: middle;
      alignment-baseline: central;
    }
  
    .button {
      border-radius: 3px;
      background-color: #eee;
      padding: 5px;
      margin: 5px;
      cursor: default;
      font-family: Courier;
      font-size: 0.85em;
      font-weight: bold;
      cursor: default;
      user-select: none;
    }
  </style>
  <div class="text-center mb-2">
    Show <span class="button filter" id="all">all</span>
    <span class="button filter" id="europe">European countries</span>
    <span class="button filter" id="asia">Asian countries</span>
    <span class="button filter" id="america">American countries</span>
  </div>
  
  <div class="text-center mb-2">
    Sort by <span class="button sort" id="life_expectancy">life_expectancy</span>
    <span class="button sort" id="wage_ratio">wage_ratio</span>
  </div>
  
  <div id="chart"></div>
  
  <script>
    var margin = { top: 20, left: 75, bottom: 50, right: 50 },
      width = 850 - margin.left - margin.right,
      height = 350 - margin.top - margin.bottom;
  
    var svg = d3.select('#chart').append('svg')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height + margin.top + margin.bottom)
      .append('g')
      .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');
  
    var all, europe, asia, america;
    d3.tsv('data/life_expectancy_and_wages.tsv', d => {
      return {
        // unary plus used to convert values to numbers
        // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Unary_plus
        name: d.name,
        life_expectancy: +d.life_expectancy,
        wage_ratio: +d.wage_ratio,
        continent: d.continent,
      };
    }).then(data => {
      all = data;
  
      //initialize data variables
      europe = data.filter(country => country.continent == 'Europe');
      america = data.filter(country => country.continent == 'America');
      asia = data.filter(country => country.continent == 'Asia');
  
      //set initial state
      filter('#all');
      sort('#life_expectancy');
  
      toggleFilter('#all');
      toggleSort('#life_expectancy');
  
      draw();
    });
  
    ///////////////////////////////////////////////////////////////
    // Controls
    ///////////////////////////////////////////////////////////////
  
    var current, sortMode, filterMode;
  
    //sort event handlers
    d3.select('#wage_ratio')
      .on('click', () => {
        //sort by wage_ratio
        sort('#wage_ratio');
        transition();
        toggleSort('#wage_ratio');
      });
  
    d3.select('#life_expectancy')
      .on('click', () => {
        //sort by life_expectancy
        sort('#life_expectancy');
        transition();
        toggleSort('#life_expectancy');
      });
  
    //filter event handlers
    d3.select('#all')
      .on('click', () => {
        filter('#all');
        sort(sortMode);
  
        toggleSort(sortMode);
        toggleFilter('#all');
  
        redraw();
      });
  
    d3.select('#europe')
      .on('click', () => {
        filter('#europe');
        sort(sortMode);
  
        toggleSort(sortMode);
        toggleFilter('#europe');
  
        redraw();
      });
  
    d3.select('#asia')
      .on('click', () => {
        filter('#asia');
        sort(sortMode);
  
        toggleSort(sortMode);
        toggleFilter('#asia');
  
        redraw();
      });

    d3.select('#america')
      .on('click', () => {
        filter('#america');
        sort(sortMode);
  
        toggleSort(sortMode);
        toggleFilter('#america');
  
        redraw();
      });
  
    function filter(mode) {
      if (mode === '#all') {
        current = JSON.parse(JSON.stringify(all));
      } else if (mode === '#europe') {
        current = JSON.parse(JSON.stringify(europe));
      } else if (mode === '#america') {
        current = JSON.parse(JSON.stringify(america));
      } else if (mode === '#asia') {
        current = JSON.parse(JSON.stringify(asia));
      }
      filterMode = mode;
    }
  
    function sort(mode) {
      if (mode === '#life_expectancy') {
        current.sort((a, b) => d3.ascending(a.life_expectancy, b.life_expectancy));
        //update x axis label
        d3.select('#x-axis-label').text('Sorted → from smaller to larger life expectancy at birth');
      } else if (mode === '#wage_ratio') {
        current.sort((a, b) => d3.ascending(a.wage_ratio, b.wage_ratio));
        //update x axis label
        d3.select('#x-axis-label').text('Sorted → from smaller to larger ratio of male to female wages');
      }
      x.domain(current.map(d => d.name));
      sortMode = mode;
    }
  
    function toggleSort(id) {
      d3.selectAll('.sort')
        .style('background-color', '#eee');
      d3.select(id)
        .style('background-color', 'lightblue'); // #add8e6 is hex code for lightblue
    }
  
    function toggleFilter(id) {
      //toggle buttons with class .filter
      d3.selectAll('.filter')
        .style('background-color', '#eee');
      d3.select(id)
        .style('background-color', 'lightblue');
    }
  
    ///////////////////////////////////////////////////////////////
    // draw the chart
    ///////////////////////////////////////////////////////////////
  
    var x = d3.scaleBand();
    var y = d3.scaleLinear();
  
    var delay = function (d, i) {
      return i * 50;
    };
  
    function redraw() {
      //update scale
      x.domain(current.map(d => d.name));
  
      ////////////////////////////////
      // DATA JOIN FOR BARS.
      var bars = svg.selectAll('.bar')
        .data(current, d => d.name);
  
      // UPDATE.
      bars.transition()
        .duration(750)
        .delay(delay)
        .attr('x', d => x(d.name))
        .attr('width', x.bandwidth());
  
      // ENTER.
      bars.enter()
        .append('rect')
        .attr('x', d => x(d.name))
        .attr('y', d => y(0))
        .attr('width', x.bandwidth())
        .transition()
        .duration(750)
        .attr('class', 'bar')
        .attr('x', d => x(d.name))
        .attr('y', d => y(d.life_expectancy))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.life_expectancy));
  
      // EXIT.
      bars.exit()
        .transition()
        .duration(750)
        .style('opacity', 0)
        .remove();
  
      ////////////////////////////////
      // DATA JOIN FOR NAMES.
      var name = svg.selectAll('.name')
        .data(current, d => d.name);
  
      // UPDATE.
      name.transition()
        .duration(750)
        .delay(delay)
        .attr('x', (d, i) => x(d.name) + x.bandwidth() / 2);
  
      // ENTER.
      name.enter()
        .append('text')
        .attr('x', d => x(d.name) + x.bandwidth() / 2)
        .attr('y', d => y(d.life_expectancy) + (height - y(d.life_expectancy)) / 2)
        .style('opacity', 0)
        .transition()
        .duration(1000)
        .text(d => d.name)
        .attr('class', 'name')
        .attr('x', d => x(d.name) + x.bandwidth() / 2)
        .attr('y', d => y(d.life_expectancy) + (height - y(d.life_expectancy)) / 2)
        .style('opacity', 1);
  
      // EXIT.
      name.exit()
        .transition()
        .duration(750)
        .style('opacity', 0)
        .remove();
    }
  
    function transition() {
      var transition = svg.transition()
        .duration(750);
  
      transition.selectAll('.bar')
        .delay(delay)
        .attr('x', d => x(d.name));
  
      transition.selectAll('.name')
        .delay(delay)
        .attr('x', d => x(d.name) + x.bandwidth() / 2);
    }
  
    function draw() {
      x.domain(current.map(d => d.name))
        .range([0, width])
        .paddingInner(0.2);
  
      y.domain([0, d3.max(current, d => d.life_expectancy)])
        .range([height, 0]);
  
      svg.selectAll('.bar')
        .data(current, d => d.name)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.name))
        .attr('y', d => y(d.life_expectancy))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.life_expectancy));
  
      svg.selectAll('.name')
        .data(current, d => d.name)
        .enter()
        .append('text')
        .text(d => d.name)
        .attr('class', 'name')
        .attr('x', d => x(d.name) + x.bandwidth() / 2)
        .attr('y', d => y(d.life_expectancy) + (height - y(d.life_expectancy)) / 2);
  
      var xAxis;
      xAxis = d3.axisBottom()
        .scale(x)
        .ticks(0)
        .tickSize(0)
        .tickFormat('');
  
      svg.append('g')
        .attr('class', 'axis')
        .attr('transform', 'translate(0,' + height + ')')
        .call(xAxis);
  
      svg.append('text')
        .attr('x', width / 2)
        .attr('y', height + 20)
        .attr('class', 'label')
        .text('Sorted → from smaller to larger life expectancy at birth')
        .attr('id', 'x-axis-label');
  
      var yAxis = d3.axisLeft()
        .scale(y)
        .ticks(5, 'd');
  
      svg.append('g')
        .attr('class', 'axis')
        .call(yAxis);
  
      svg.append('text')
        .attr('x', - height / 2)
        .attr('y', - margin.left * 0.7)
        .attr('transform', 'rotate(-90)')
        .attr('class', 'label')
        .append('tspan').text('life_expectancy (years)')
        .append('tspan').text('')
        .style('baseline-shift', 'super')
        .style('font-size', '0.7em');
    }
  </script>

</body>